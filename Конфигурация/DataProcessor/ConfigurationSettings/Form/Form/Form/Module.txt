
#Region CommonProceduresAndFunctions

&AtServer
Procedure OnCreateAtServer(Cancel, StandardProcessing)
	
	ControlOrderReasonEnabled	= Catalogs.MobileAppSettings.ControlOrderReasonEnabled.LogicValue;
	ControlVisitReasonEnabled	= Catalogs.MobileAppSettings.ControlVisitReasonEnabled.LogicValue;
	CoordinateControlEnabled	= Catalogs.MobileAppSettings.CoordinateControlEnabled.LogicValue;
	EmptyStockEnabled			= Catalogs.MobileAppSettings.EmptyStockEnabled.LogicValue;
	MultistockEnabled			= Catalogs.MobileAppSettings.MultistockEnabled.LogicValue;
	PlanVisitEnabled			= Catalogs.MobileAppSettings.PlanVisitEnabled.LogicValue;
	RecOrderEnabled				= Catalogs.MobileAppSettings.RecOrderEnabled.LogicValue;
	SnapshotSize				= Catalogs.MobileAppSettings.SnapshotSize.NumericValue;
	SKUFeaturesRegistration		= Catalogs.MobileAppSettings.SKUFeaturesRegistration.LogicValue;
	
	CreateReturnsEnabled		= Constants.UseReturns.Get();
	CreateOrdersEnabled			= Constants.UseOrders.Get();
	CreateEncashmentsEnabled	= Constants.UseEncashments.Get();
	
	SizeOfThumbnailPhotos		= Constants.SizeOfThumbnailPhotos.Get();
	
EndProcedure

&AtServer
Procedure SaveSettingsServer()
	
	ControlOrderReasonEnabledObject				= Catalogs.MobileAppSettings.ControlOrderReasonEnabled.GetObject();
	ControlOrderReasonEnabledObject.LogicValue	= ControlOrderReasonEnabled;
	
	ControlOrderReasonEnabledObject.Write();
	
	ControlVisitReasonEnabledObject				= Catalogs.MobileAppSettings.ControlVisitReasonEnabled.GetObject();
	ControlVisitReasonEnabledObject.LogicValue	= ControlVisitReasonEnabled;
	
	ControlVisitReasonEnabledObject.Write();
	
	CoordinateControlEnabledObject				= Catalogs.MobileAppSettings.CoordinateControlEnabled.GetObject();
	CoordinateControlEnabledObject.LogicValue	= CoordinateControlEnabled;
	
	CoordinateControlEnabledObject.Write();
	
	EmptyStockEnabledObject						= Catalogs.MobileAppSettings.EmptyStockEnabled.GetObject();
	EmptyStockEnabledObject.LogicValue			= EmptyStockEnabled;
	
	EmptyStockEnabledObject.Write();
	
	SKUFeaturesRegistrationObject				= Catalogs.MobileAppSettings.SKUFeaturesRegistration.GetObject();
	SKUFeaturesRegistrationObject.LogicValue	= SKUFeaturesRegistration;
	
	SKUFeaturesRegistrationObject.Write();
	
	Constants.SKUFeaturesRegistration.Set(SKUFeaturesRegistration);
	
	MultistockEnabledObject						= Catalogs.MobileAppSettings.MultistockEnabled.GetObject();
	MultistockEnabledObject.LogicValue			= MultistockEnabled;
	
	MultistockEnabledObject.Write();
	
	Constants.MultiStock.Set(MultistockEnabled);
	
	PlanVisitEnabledObject						= Catalogs.MobileAppSettings.PlanVisitEnabled.GetObject();
	PlanVisitEnabledObject.LogicValue			= PlanVisitEnabled;
	
	PlanVisitEnabledObject.Write();
	
	RecOrderEnabledObject						= Catalogs.MobileAppSettings.RecOrderEnabled.GetObject();
	RecOrderEnabledObject.LogicValue			= RecOrderEnabled;
	
	RecOrderEnabledObject.Write();
	
	SnapshotSizeObject							= Catalogs.MobileAppSettings.SnapshotSize.GetObject();
	SnapshotSizeObject.NumericValue				= SnapshotSize;
	
	SnapshotSizeObject.Write();
	
	Constants.UseReturns.Set(CreateReturnsEnabled);
	Constants.UseOrders.Set(CreateOrdersEnabled);
	Constants.UseEncashments.Set(CreateEncashmentsEnabled);
	
	Constants.SizeOfThumbnailPhotos.Set(SizeOfThumbnailPhotos);
	
	If Not CreateReturnsEnabled Then 
		
		DeleteAccessRightFromRole(Catalogs.MobileAppAccessRights.AccessToReturn);
		
	EndIf;
	
	If Not CreateOrdersEnabled Then 
		
		DeleteAccessRightFromRole(Catalogs.MobileAppAccessRights.AccessToOrder);
		
	EndIf;
	
	If Not CreateEncashmentsEnabled Then 
		
		DeleteAccessRightFromRole(Catalogs.MobileAppAccessRights.AccessToEncashment);
		
	EndIf;
	
EndProcedure

&AtServer
Procedure DeleteAccessRightFromRole(AccessRight)
	
	Query = New Query;
	Query.Text = 
		"SELECT
		|	RolesOfUsersMobileAppAccessRights.AccessRight,
		|	RolesOfUsersMobileAppAccessRights.Ref AS RolesOfUser
		|FROM
		|	Catalog.RolesOfUsers.MobileAppAccessRights AS RolesOfUsersMobileAppAccessRights
		|WHERE
		|	RolesOfUsersMobileAppAccessRights.AccessRight = &AccessRight";
	
	Query.SetParameter("AccessRight", AccessRight);
	
	QueryResult = Query.Execute();
	
	Selection = QueryResult.Select();
	
	While Selection.Next() Do
		
		RO_Object = Selection.RolesOfUser.GetObject();
		
		RowToDelete = RO_Object.MobileAppAccessRights.Find(AccessRight);
		
		RO_Object.MobileAppAccessRights.Delete(RowToDelete);
		
		RO_Object.Write();
		
	EndDo;
	
EndProcedure

#EndRegion

#Region UserInterface

&AtClient
Procedure SaveSettings(Command)
	
	SaveSettingsServer();
	
	RefreshInterface();
	
	Notify("UserRoleWrite");
	
EndProcedure

#EndRegion