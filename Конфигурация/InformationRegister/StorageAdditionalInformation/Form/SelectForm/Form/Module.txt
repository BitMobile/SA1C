
#Region CommonProcedureAndFunctions

&AtServer
Procedure ShowPreview()
	
	If ValueIsFilled(Items.List.CurrentRow) Then 
	
		RecordManager = InformationRegisters.StorageAdditionalInformation.CreateRecordManager();
		
		FillPropertyValues(RecordManager, Items.List.CurrentRow);
		
		RecordManager.Read();
		
		BinaryDataOfFile = RecordManager.Storage.Get();
		
		If ValueIsFilled(BinaryDataOfFile) Then 
		
			Preview = PutToTempStorage(BinaryDataOfFile, ThisForm.UUID);
			
		Else 
			
			Password 	= Constants.bitmobile_Пароль.Get();
			Server 		= StrReplace(Constants.bitmobile_Сервер.Get(), "localhost", "127.0.0.1");
			Path 		= Constants.bitmobile_ПутьНаСервере.Get();
			Path 		= StrReplace(Path, "admin", "webdav");
			Port 		= Constants.bitmobile_Порт.Get();
			
			Try
	
				Connection = New HTTPConnection(Server, ?(Port = 0, 80, Port), "admin", Password);
				
			Except
				
				Connection = Undefined;
				
			EndTry;
			
			If Not Connection = Undefined Then 
			
				Try
					
					WebDAVFile = GetTempFileName(RecordManager.Extension);
					
					Connection.Get(Path + RecordManager.FullFileName, WebDAVFile);
					
					BinaryDataOfFile = New BinaryData(WebDAVFile);
					
					Preview = PutToTempStorage(BinaryDataOfFile, ThisForm.UUID);
										
				Except
				EndTry;
				
			EndIf;
			
		EndIf;	
		
	EndIf;
		
EndProcedure
 
#EndRegion

#Region UserInterface

&AtClient
Procedure ListOnActivateRow(Item)
	
	If ShowPreview Then
		
		ShowPreview();
		
	EndIf;	
	
EndProcedure

&AtClient
Procedure ShowPreviewOnChange(Item)
	
	If ShowPreview Then
		
		ShowPreview();
		
	Else 
		
		Preview = Undefined;
		
	EndIf;	
	
EndProcedure

#EndRegion