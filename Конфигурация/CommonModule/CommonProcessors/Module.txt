
Function GetTerritory(Outlet) Export
	
	Query = New Query;
	
	Query.Text = "SELECT ALLOWED TOP 1
				|	TerritoryOutlets.Ref
				|FROM
				|	Catalog.Territory.Outlets AS TerritoryOutlets
				|WHERE
				|	TerritoryOutlets.Outlet = &Outlet";
	
	Query.SetParameter("Outlet", Outlet);
	
	Selection = Query.Execute().Select();
	Selection.Next();
	
	Return Selection.Ref;	
	
EndFunction

Function GetPredefinedItems(PredefinedItems) Export 
	
	ItemsMap = New Map;
	
	For Each Row In PredefinedItems Do
		
		If Row.Key = "Catalog.User" Then
			
			Query = New Query;
			Query.Text = "SELECT ALLOWED
						|	User.Ref AS Ref
						|FROM
						|	Catalog.User AS User
						|WHERE
						|	User.Role = &Role";
			
			Query.SetParameter("Role", "SR");
			
		Else
			
			Query = New Query;
			Query.Text = "SELECT ALLOWED Ref FROM " + Row.Key;
			
		EndIf;
		
		Result = Query.Execute().Unload();
		
		If Result.Count() = 1 Then
			
			ItemsMap.Insert(Row.Value, Result[0].Ref);
			
		EndIf;
		
	EndDo;
	
	Return ItemsMap;
	
EndFunction

Function GetQuestionGroupType(TypeString = "SKUQuestions") Export
	
	If TypeString = "SKUQuestions" Then 
		
		Return Enums.QuestionGroupTypes.SKUQuestions;
		
	Else 
		
		Return Enums.QuestionGroupTypes.RegularQuestions;
		
	EndIf;
	
EndFunction

Function StringToNumber(String) Export
	
	Try
		
		Result = Number(String);
		
	Except
		
		Result = 0;
		
	EndTry;
	
	Return Result;
	
EndFunction

Function GetConnectionToServer() Export
	
	// Инициализация подключения
	Password = Constants.bitmobile_Пароль.Get();
	Server = StrReplace(Constants.bitmobile_Сервер.Get(), "localhost", "127.0.0.1");
	Port = Constants.bitmobile_Порт.Get();
	
	Try
		
		Return New HTTPConnection(Server, ?(Port = 0, 80, Port), "admin", Password);
		
	Except
		
		Return Undefined;
		
	EndTry;
	
EndFunction

Function GetWebDAVPathOnServer() Export
	
	Path = Constants.bitmobile_ПутьНаСервере.Get();
	
	Return StrReplace(Path, "admin/", "webdav");
	
EndFunction

Function GetSnapshot(FileUUID, FormUUID, NameForFile) Export
	
	If ValueIsFilled(FileUUID) Then
		
		Try
			
			If TypeOf(FileUUID) = Type("String") Then 
				
				ShapshotUUID = New UUID(FileUUID);
				
			Else 
				
				ShapshotUUID = FileUUID;
				
			EndIf;
			
			// Ищем данные о файле
			FileRow = InformationRegisters.bitmobile_ХранилищеФайлов.Select(New Structure("ИмяФайла", ShapshotUUID));
			
			// Если найден уид в таблице файлов
			If FileRow.Next() Then
				
				Connection = CommonProcessors.GetConnectionToServer();
				
				Path = CommonProcessors.GetWebDAVPathOnServer();
				
				// Забираем бинарные данные из таблицы файлов
				BinaryDataOfFile = FileRow.Хранилище.Get();
				
				// Если бинарные данные есть
				If ValueIsFilled(BinaryDataOfFile) Then
					
					ReturnStructure = New Structure("SnapshotAddress, SnapshotName", PutToTempStorage(BinaryDataOfFile, FormUUID), NameForFile + FileRow.Расширение);
					
					Return ReturnStructure;
					
				// Если нет бинарных данных
				Else
					
					// Если соединение было создано успешно
					If Not Connection = Undefined Then
						
						// Пробуем забрать файл
						Try
							
							WebDAVFile = GetTempFileName(FileRow.Расширение);
							
							Connection.Get(Path + FileRow.ПолноеИмяФайла, WebDAVFile);
							
							BinaryDataOfFile = New BinaryData(WebDAVFile);
							
							ReturnStructure = New Structure("SnapshotAddress, SnapshotName", PutToTempStorage(BinaryDataOfFile, FormUUID), NameForFile + FileRow.Расширение);
							
							Return ReturnStructure;
							
						Except
						EndTry;
						
					EndIf;
					
				EndIf;
				
			EndIf;
			
		Except
		EndTry;
		
	EndIf;
	
	Return Undefined;
	
EndFunction

Procedure FillDefaultValues_DocumentBeforeWrite(Source, Cancel, WriteMode, PostingMode) Export
	
	If Source.DataExchange.Load Or Source.AdditionalProperties.Property("FillDefaultValues") Then 
		
		FillDefaultValues(Source, Source.AdditionalProperties.Property("ЗагрузкаBitmobile"));
		
	EndIf;
	
EndProcedure

Procedure FillDefaultValues_CatalogBeforeWrite(Source, Cancel) Export
	
	If Source.DataExchange.Load Or Source.AdditionalProperties.Property("FillDefaultValues") Then 
		
		FillDefaultValues(Source, Source.AdditionalProperties.Property("ЗагрузкаBitmobile"));
		
	EndIf;
	
EndProcedure

Procedure FillDefaultValues(Source, IsBMLoad)
	
	Query = New Query;
	Query.Text = 
		"SELECT
		|	DefaultValues.Object AS Object,
		|	DefaultValues.TabularSection AS TabularSection,
		|	DefaultValues.Attribute AS Attribute,
		|	DefaultValues.Value,
		|	DefaultValues.TypeName
		|FROM
		|	InformationRegister.DefaultValues AS DefaultValues
		|WHERE
		|	DefaultValues.Object = &ObjectName
		|
		|ORDER BY
		|	Object,
		|	TabularSection,
		|	Attribute";
	
	Query.SetParameter("ObjectName", Source.Metadata().Name);
	
	DefaultValuesTable = Query.Execute().Unload();
	
	TabularSectionsTable = DefaultValuesTable.Copy();
	
	TabularSectionsTable.GroupBy("TabularSection");
	
	For Each TabularSectionsRow In TabularSectionsTable Do 
		
		ProcessedData = DefaultValuesTable.FindRows(New Structure("TabularSection", TabularSectionsRow.TabularSection));
		
		If ValueIsFilled(TabularSectionsRow.TabularSection) Then // TS attributes 
			
			For Each TSItem In Source[TabularSectionsRow.TabularSection] Do 
				
				For Each ProcessedValue In ProcessedData Do  
				
					If ValueIsFilled(ProcessedValue.Value) And Not ValueIsFilled(TSItem[ProcessedValue.Attribute]) Then 
						
						Try
							
							TSItem[ProcessedValue.Attribute] = ProcessedValue.Value;
							
						Except
						
						EndTry;
						
						If IsBMLoad Then 
							
							Source.AdditionalProperties.Delete("ЗагрузкаBitmobile");
							
							IsBMLoad = False;
							
						EndIf;
						
					EndIf;
					
				EndDo;
				
			EndDo;
			
		Else // Object attributes
			
			For Each ProcessedValue In ProcessedData Do  
				
				If ValueIsFilled(ProcessedValue.Value) And Not ValueIsFilled(Source[ProcessedValue.Attribute]) Then 
					
					Try
						
						Source[ProcessedValue.Attribute] = ProcessedValue.Value;
						
					Except
					
					EndTry;
					
					If IsBMLoad Then 
						
						Source.AdditionalProperties.Delete("ЗагрузкаBitmobile");
						
						IsBMLoad = False;
						
					EndIf;
					
				EndIf;
				
			EndDo;
			
		EndIf;
		
	EndDo;
	
EndProcedure


