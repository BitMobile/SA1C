
#Region CommonProcedureAndFunctions

&AtServer
Procedure OnOpenServer()

	If Not IsInRole("Admin") Then
		
		ThisForm.ReadOnly = True;
		
	EndIf;
	
	If ValueIsFilled(Object.Ref) Then 
		
		RecordSet								= InformationRegisters.QuestioningResults.CreateRecordSet();
		RecordSet.Filter.Visit.Use				= True;
		RecordSet.Filter.Visit.ComparisonType	= ComparisonType.Equal;
		RecordSet.Filter.Visit.Value			= Object.Ref;
		
		RecordSet.Read();
		
		ValueToFormData(RecordSet, TempQuestionaires);
		
		For Each StrResult In TempQuestionaires Do 
			
			StrResult.QuestionnaireResult = NStr("en = 'Result for ""'; ru = 'Результат для ""'") + String(StrResult.Questionnaire) + """";
			
		EndDo;
		
	EndIf;
	
EndProcedure

&AtServerNoContext
Function GetRecordKey(KeyData)
	
	Return InformationRegisters.QuestioningResults.CreateRecordKey(KeyData);
	
EndFunction

#EndRegion

#Region UserInterface

&AtClient
Procedure OnOpen(Cancel)
	
	OnOpenServer();
	
EndProcedure

&AtClient
Procedure TempQuestionairesSelection(Item, SelectedRow, Field, StandardProcessing)
	
	If Not Items.TempQuestionaires.CurrentData = Undefined Then 
		
		CurrenRowData = TempQuestionaires.FindByID(Items.TempQuestionaires.CurrentRow);
		
		KeyData = New Structure;
		KeyData.Insert("Questionnaire",CurrenRowData.Questionnaire);
		KeyData.Insert("Visit",CurrenRowData.Visit);
		KeyData.Insert("Outlet",CurrenRowData.Outlet);
		KeyData.Insert("SR",CurrenRowData.SR);
		KeyData.Insert("Date",CurrenRowData.Date);
		
		RecordKey = GetRecordKey(KeyData);
		
		OpenForm("InformationRegister.QuestioningResults.RecordForm", New Structure("Key", RecordKey));
		
	EndIf;
	
EndProcedure

#EndRegion
