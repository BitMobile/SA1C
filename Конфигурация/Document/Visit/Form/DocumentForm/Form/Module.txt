
///////////////////////////////////////////////////////
// Common procedure and functions

&AtServer
Procedure OnOpenServer()

	If Not IsInRole("Admin") Then
		
		ThisForm.ReadOnly = True;
		
	EndIf; 
		
EndProcedure

&AtServer
Procedure SetPicture(SnapShotUUID)
	
	SelectionStructure = New Structure("FileName");
	SelectionStructure.FileName = SnapShotUUID;
					
	Selection = InformationRegisters.StorageAdditionalInformation.Select(SelectionStructure);
	
	If Selection.Next() Then 
		
		PictureAddress 		= PutToTempStorage(Selection.Storage.Get(), ThisForm.UUID);
		PictureExtension	= Selection.Extension;
		
	EndIf;
				
EndProcedure

&AtServer
Function ItsPicture(Question)
	
	If Question.AnswerType = Enums.DataType.Snapshot Then 
		
		Return True;
		
	Else 
		
		Return False;
		
	EndIf;
			
EndFunction

&AtServer
Function PictureExists(SnapShotUUID)
	
	SelectionStructure = New Structure("FileName");
	SelectionStructure.FileName = SnapShotUUID;
	
	Selection = InformationRegisters.StorageAdditionalInformation.Select(SelectionStructure);
	
	If Selection.Next() Then
		
		Return True;
		
	Else
		
		Return False;
		
	EndIf;

EndFunction


///////////////////////////////////////////////////////
// User interface

&AtClient
Procedure OnOpen(Cancel)
    
    OnOpenServer();
	
    For Each Str in Object.Questions Do
		
		AddQuestionaire(Str);	
		
		FoundedRows = TempQuestions.FindRows(New Structure("Question", Str.Question));
		
		If FoundedRows.Count() = 0 Then 		
		
			Ins 			= TempQuestions.Add();
	        Ins.Question 	= Str.Question;
	        
	        If ItsPicture(Str.Question) Then 
				
				Try
					SnapShotUUID = New UUID(Str.Answer);
				Except
				EndTry;
				
				If PictureExists(SnapShotUUID) Then
					
	            	Ins.Answer 			= NStr("en = 'Snapshot'; ru = 'Фотоснимок'");
	            	Ins.SnapShotUUID 	= Str.Answer;
					
				Else
					
					Ins.Answer 			= NStr("en = ""Picture not found on server""; ru = ""Изображение не найдено на сервере""");
					Ins.SnapShotUUID 	= Str.Answer;
					
				EndIf;
	            
	        Else 
	            
	            Ins.Answer = Str.Answer;
	            
			EndIf;
			
		EndIf;	
                        
	EndDo;
	
	For Each Str In Object.SKUs Do
		
		AddQuestionaire(Str);
		
		FoundedRows = TempSKUs.FindRows(New Structure("SKU, Question", Str.SKU, Str.Question));
		
		If FoundedRows.Count() = 0 Then
		
	        Ins 			= TempSKUs.Add();
	        Ins.SKU 		= Str.SKU;
	        Ins.Question 	= Str.Question;
	        
	        If ItsPicture(Str.Question) Then
				
				Try
					
					SnapShotUUID = New UUID(Str.Answer);            	            
					
				Except
	            EndTry;
				
				If PictureExists(SnapShotUUID) Then
					
					Ins.Answer 			= NStr("en = 'Snapshot'; ru = 'Фотоснимок'");
	                Ins.SKUSnapShotUUID = Str.Answer;                	                
					
				Else
					
					Ins.Answer 			= NStr("en = ""Picture not found on server""; ru = ""Изображение не найдено на сервере""");
	                Ins.SKUSnapShotUUID = Str.Answer;                
					
				EndIf;            
				
			Else
				
				Ins.Answer = Str.Answer;        	        
				
			EndIf;
			
		EndIf;	
        
    EndDo;
	 
EndProcedure

&AtClient
Procedure AddQuestionaire(Str)
	
	If ValueIsFilled(Str.Questionnaire) Then 
	
		FoundedRows = TempQuestionaires.FindRows(New Structure("Questionaire", Str.Questionnaire));
			
		If FoundedRows.Count() = 0 Then 
			
			Ins 				= TempQuestionaires.Add();
	        Ins.Questionnaire 	= Str.Questionnaire;	
			
		EndIf;
		
	EndIf;	
	
EndProcedure

&AtClient
Procedure QuestionsOnActivateRow(Item)
	
	If Items.Pages.CurrentPage = Items.GroupQuestions Then
	
		If Not Item.CurrentRow = Undefined Then	
		
			If ItsPicture(Item.CurrentData.Question) Then 
							
				SnapShotUUID = New UUID(Item.CurrentData.SnapShotUUID);
				
				SetPicture(SnapShotUUID);
				
			Else 
				
				PictureAddress		= Undefined;
				PictureExtension    = Undefined;
			
			EndIf;
			
		Else
			
			PictureAddress		= Undefined;
			PictureExtension    = Undefined;

		EndIf;
		
	EndIf;
		
EndProcedure

&AtClient
Procedure TempSKUsOnActivateRow(Item)
	
	If Items.Pages.CurrentPage = Items.GroupSKUs Then
	
	    If Not Item.CurrentRow = Undefined  Then	        
			
			If Not Item.CurrentData.SKUSnapShotUUID = "" Then            
				
				SnapShotUUID = New UUID(Item.CurrentData.SKUSnapShotUUID);			
				
				SetPicture(SnapShotUUID);            
				
			Else            
				
				PictureAddress		= Undefined;
	            PictureExtension    = Undefined;                       
				
			EndIf;                
			
		Else        
			
			PictureAddress		= Undefined;
	        PictureExtension    = Undefined;        
			
		EndIf;
		
	EndIf;	
    
EndProcedure

&AtClient
Procedure OpenPicture(Command)
	
	FileName = Undefined;
	
	If ValueIsFilled(PictureAddress) Then 
		
		FileName = "picture" + PictureExtension;
		
	EndIf;
		
	If ValueIsFilled(FileName) Then 
		
		GetFile(PictureAddress, FileName, True);
		
	EndIf;
	
EndProcedure

&AtClient
Procedure PagesOnCurrentPageChange(Item, CurrentPage)
	
	If CurrentPage = Items.GroupQuestions Then
		
		QuestionsOnActivateRow(Items.TempQuestions);
        
    ElsIf CurrentPage = Items.GroupSKUs Then
        
        TempSKUsOnActivateRow(Items.TempSKUs);
		
	Else 
		
		PictureAddress = Undefined;
		PictureExtension = Undefined;
        
	EndIf;
			
EndProcedure
